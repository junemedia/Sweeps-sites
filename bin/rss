#!/usr/bin/php
<?php

$db = new MySQLi(
      ini_get("mysqli.default_host")
    , ini_get("mysqli.default_user")
    , ini_get("mysqli.default_pw")
    , 'sweeps'
    , ini_get("mysqli.default_port")
);

if ($db->connect_error) {
    die("Could not connect to MySQL: ".$db->connect_error);
}

$items = array();
// 'site_id'     => …
// 'title'       => …
// 'description' => …
// 'link'        => …

$q = $db->query('SELECT `id` `site_id`, `rss` `url` FROM `site` WHERE `rss` IS NOT NULL');
while ($r = $q->fetch_assoc()) {
    $ch = curl_init($r['url']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $rss = curl_exec($ch);
    $xml = simplexml_load_string($rss);
    if ($xml){
        $xml = (array) $xml->channel;
        foreach (@$xml['item'] as $i) {
            if (!strlen($i->title)) {
                continue;
            }
            array_push(
                $items,
                array(
                    'site_id' => $r['site_id'],
                    'title' => trim((string) $i->title),
                    'description' => trim((string) $i->description),
                    'link' => trim((string) $i->link)
                )
            );
        }
    }
}


$db->query('TRUNCATE TABLE `rss`');
$stmt = $db->prepare('INSERT INTO `rss` VALUES (?, ?, ?, ?)');
$stmt->bind_param('isss', $site_id, $title, $description, $link);

foreach ($items as $item) {
    extract($item);
    $stmt->execute();
}
