#!/bin/sh

YEAR=`date +%Y`

NEWSLETTER_TMP=/tmp/sweeps_newsletter-$YEAR.csv
NEWSLETTER_CSV=/srv/sites/sweeps/web/reports/newsletter-$YEAR.csv
mkdir -p "`dirname $NEWSLETTER_CSV`"

mysql sweeps -s -e "SELECT CONCAT('\"',GROUP_CONCAT(COLUMN_NAME SEPARATOR '\",\"'),'\"') FROM information_schema.COLUMNS C WHERE table_name = 'view_stat_newsletter_current_year'" > $NEWSLETTER_CSV && \
mysql sweeps -e "SELECT * INTO OUTFILE '$NEWSLETTER_TMP' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' FROM view_stat_newsletter_current_year" && \
ssh mdb "cat $NEWSLETTER_TMP" >> $NEWSLETTER_CSV && \
ssh mdb "rm -f $NEWSLETTER_TMP" && \
gzip -c9 $NEWSLETTER_CSV > $NEWSLETTER_CSV.gz

OFFER_TMP=/tmp/sweeps_offer-$YEAR.csv
OFFER_CSV=/srv/sites/sweeps/web/reports/offer-$YEAR.csv
mkdir -p "`dirname $OFFER_CSV`"

mysql sweeps -s -e "SELECT CONCAT('\"',GROUP_CONCAT(COLUMN_NAME SEPARATOR '\",\"'),'\"') FROM information_schema.COLUMNS C WHERE table_name = 'view_stat_offer_current_year'" > $OFFER_CSV && \
mysql sweeps -e "SELECT * INTO OUTFILE '$OFFER_TMP' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' FROM view_stat_offer_current_year" && \
ssh mdb "cat $OFFER_TMP" >> $OFFER_CSV && \
ssh mdb "rm -f $OFFER_TMP" && \
gzip -c9 $OFFER_CSV > $OFFER_CSV.gz
