#!/bin/sh

function generate {
    TMP=$1
    CSV=$2
    VIEW=$3

    mkdir -p "`dirname $CSV`"

    mysql junesweeps -s -e "SELECT CONCAT('\"',GROUP_CONCAT(COLUMN_NAME SEPARATOR '\",\"'),'\"') FROM information_schema.COLUMNS C WHERE table_name = '$VIEW'" > $CSV && \
    mysql junesweeps -e "SELECT * INTO OUTFILE '$TMP' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' FROM $VIEW" && \

    ssh mdb "cat $TMP" >> $CSV && \
    ssh mdb "rm -f $TMP" && \

    gzip -c9 $CSV > $CSV.gz
}

generate \
    /tmp/junesweeps-users.csv \
    /srv/sites/junesweeps/web/reports/users.csv \
    report_user
