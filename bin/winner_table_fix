#!/usr/bin/php
<?php

define('ENVIRONMENT', 'production');

$db = new MySQLi(
      ini_get("mysqli.default_host")
    , ini_get("mysqli.default_user")
    , ini_get("mysqli.default_pw")
    , 'sweeps'
    , ini_get("mysqli.default_port")
);

if ($db->connect_error) {
    die("Could not connect to MySQL: ".$db->connect_error);
}


// define $property_by_channel_id
$q = $db->query('SELECT `channel_id`, `domain`, `channel_url` FROM `view_channel`');
while ($r = $q->fetch_assoc()) {
    $property_by_channel_id[$r['channel_id']] =
        trim($r['domain'] . $r['channel_url'], '/');
}

require_once '/srv/sites/sweeps/app/libraries/Reg.php';
$reg = new Reg(
    array(
        'client_code' => 1004,
        'site'        => 'parents',
        'debug'       => true
    )
);

$winners = array();
$q = $db->query('SELECT `day`, `rule_id`, `profile_id`, `prize_id`, `channel_id` FROM `winner` WHERE `day` >= "2014-10-09"');
while ($r = $q->fetch_assoc()) {
    $profile = array_merge($r, $reg->getProfile($r['profile_id']));
    sanitizeWinner($profile);
    updateWinner($profile);
    print_r($profile);
}

function updateWinner($profile) {
    global $db;
    extract($profile);
    $sql = sprintf('UPDATE `winner` SET
            `name`=%s,
            `location`=%s,
            `property`=%s
            WHERE   `day`="%s"
            AND     `rule_id`=%d
            AND     `profile_id`="%s"
            AND     `prize_id`=%d
            AND     `channel_id`=%d',
            nullEscapeString($name),
            nullEscapeString($location),
            nullEscapeString($property),
            $day,
            $rule_id,
            $profile_id,
            $prize_id,
            $channel_id);
// echo $sql.PHP_EOL;exit;
    $db->query($sql);
}




function nullEscapeString($str) {
    global $db;
    return $str ?
        "'".$db->real_escape_string($str)."'"
        : 'NULL';
}


function sanitizeWinner(&$profile)
{
    global $property_by_channel_id;

    // assign email -> login if that's not already set
    if (!@$profile['email']) {
        $profile['email'] = $profile['login'];
    }
    // name
    if (!@$profile['name']) {
        $profile['name'] = $profile['firstname'];
        if (@$profile['lastname']) {
            $profile['name'] .= ' ' . $profile['lastname'][0] . '.';
        }
    }
    // location
    if (!@$profile['location']) {
        if (@$profile['city']) {
            $profile['location'] = $profile['city'] . ', ';
        }
        $profile['location'] .= $profile['state'];
    }
    // property
    if (!@$profile['property']) {
        $profile['property'] = $property_by_channel_id[$profile['channel_id']];
    }
}