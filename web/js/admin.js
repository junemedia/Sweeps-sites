"use strict";!function(a,b,c,d,e,f){function g(a,b,c){(!c&&0!==c||1!=c.toString().length)&&(c=" "),a=a.toString();for(var d=a.length+1,e="";d++<=b;)e+=c;return e+a}function h(a,c){var d,e="string"==b.type(a)&&a.match(/^(\d+)-(\d+)-(\d+)$/);if(!e||4!=e.length)return c;var f=parseInt(e[1]),g=parseInt(e[2])-1,h=parseInt(e[3]);return 0>g||g>11||h>31||1>h?c:(30>f&&(f+=2e3),d=new Date(f,g,h),isNaN(d.getTime())?c:d)}function i(a){var b=new Date(a);return b?[b.getFullYear().toString(),g(b.getMonth()+1,2,0),g(b.getDate(),2,0)].join("-"):""}function j(){function a(){h.attr("disabled",!1).val("Save"),i.attr("disabled",!1),k.html("")}function c(a,b){h.attr("disabled",!0).val(a||"Saved"),i.attr("disabled",!0),k.removeClass("error").html(""),l["on"==b?"addClass":"removeClass"]("on")}function d(a,c){var d=new FormData;d.append("img",a),b.ajax({url:"/admin/upload",data:d,processData:!1,contentType:!1,type:"POST"}).done(function(a){if(!c)for(var d=1;3>=d;d++)if(!b('input[name="img'+d+'"]').val()){c=d;break}var e=b('input[name="img'+c+'"]'),f=e.closest("fieldset"),g=f.find("img");f.removeClass("empty"),g.attr("src",a.url),e.val(a.md5),m[0].reset()}).fail(function(a,b,c){console.log("FAIL",a,b,c)})}var e="/img/unavailable.png",f="Server error encountered. Please try again.",g=b("form.prize"),h=g.find('input[type="submit"]'),i=g.find('input[type="reset"]'),k=g.find(".msg"),l=g.find(".loader"),m=b("form.upload"),n=m.find('input[type="file"]'),o=g.find("fieldset.img");j.id=parseInt(g.find('input[name="id"]').val()),isNaN(j.id)&&(j.id=0),g.find("input, select, textarea").on("change, keydown",a),g.on("reset",function(){return c("No Changes"),!0}),g.on("submit",function(){function d(a){return c(),a.err||!a.success?e(a.msg):(a.prize_id&&(j.id=parseInt(a.prize_id,10),g.find('input[name="id"]').val(j.id),window.location.href=window.location.href.replace(/0$/,j.id)),!1)}function e(b){return c(),a(),k.addClass("error").html(b||f),!1}return c("Savingâ€¦","on"),b.ajax({url:"/admin/prize",data:b(this).serialize(),type:"POST"}).done(d).fail(function(){console.log(arguments),e()}),!1}),n.on("change",function(){a(),d(this.files[0],n.data("index"))}),g.on("click","fieldset.img img",function(a){a.stopPropagation(),a.preventDefault();var c=b(this).closest("fieldset"),d=c.find('input[type="hidden"]').attr("name").substring(3);n.data("index",d),n.trigger("click")}),g.on("click","fieldset.img b",function(c){a(),c.stopPropagation(),c.preventDefault();var d=b(this).closest("fieldset"),f=d.find("img"),g=d.find('input[type="hidden"]');d.addClass("empty"),f.attr("src",e),g.val("")}),b(document).bind("dragover",function(a){a.preventDefault();var c,d=window.dropZoneTimeout;d?clearTimeout(d):o.addClass("in");var e=!1,f=a.target;do{if(b(f).hasClass("img")){e=!0,c=b(f);break}f=f.parentNode}while(null!==f);o.removeClass("in hover"),e&&c.addClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,o.removeClass("in hover")},100)}).bind("drop",function(c){a(),c.stopPropagation(),c.preventDefault();var e=b(c.target).closest("fieldset.img").find('input[type="hidden"]').attr("name"),f=e&&e.substring(3);return d((c.originalEvent.target.files||c.originalEvent.dataTransfer.files)[0],f),!1})}function k(){function a(a){o.html(a||r),n.addClass("error")}function c(c,d,e){return j.id?(o.html(""),n.removeClass("error"),void b.ajax({url:"/admin/contest/"+c,data:{prize_id:j.id,date:d},dataType:"json",type:"POST"}).done(function(c){c.success?"function"==b.type(e)&&e(c):a(c.msg)}).fail(function(){a()})):(a("Please save this prize before adding flight dates."),!1)}function d(){var a=[];return l.find("tr").each(function(c,d){var e=b(d).find("td:nth-child(2)").text();e.match(/\d+-\d+\d+/)&&a.push(e)}),a.last=function(){return this[this.length-1]},a}function e(a){var b=q.indexOf(a)+2;l.find("tr:nth-child("+b+")").addClass("highlight")}function f(a){c("add",a,function(){q.push(a),q.sort();var c=q.indexOf(a)+1;l.find("tr:nth-child("+c+")").after(b('<tr class="future"><td><b></b></td><td>'+a+"</td><td></td><td></td></tr>").addClass(a==p?"highlight":"")),m.val("")})}function g(a){c("del",a,function(){var b=q.indexOf(a),c=b+2;q.splice(b,1),l.find("tr:nth-child("+c+")").remove()})}function k(a){m.val(""),c("alt",a,function(b){var c=q.indexOf(a),d=c+2,e=l.find("tr:nth-child("+d+")"),f=e.find("td:nth-child(3)"),g=e.find("td:nth-child(4)"),h=b.winner;f.html('<a href="mailto:'+h.email+'">'+h.firstname+" "+h.lastname+"</a>"),g.html(h.city+", "+h.state)})}var l=b("#flight"),m=b("#add_flight"),n=l.find("tr:last-child"),o=b("#contest_error"),p=location.hash.substr(1)||h(new Date),q=d(),r="Ooops, server error, please try again";e(p),m.on("keydown",function(c){switch(c.which){case 38:case 40:var d=(h(b(this).val())||h(q.last(),new Date)).getTime();return 40==c.which?d+=864e5:d-=864e5,b(this).val(i(d)),!0;case 9:break;case 13:c.preventDefault();break;default:return!0}var e=b(this).val();return h(e)<=new Date?(a("Cannot add a date in the past"),!1):q.indexOf(e)>=0?(a("This prize is already scheduled for "+e+"."),!1):void f(e)}),l.on("click","b",function(){var a=b(this).closest("tr"),c=a.find("td:nth-child(2)").text(),d=!a.hasClass("won");d?g(c):k(c)})}function l(){b("form.prize").length&&(j(),k())}function m(a,c){if(a in m){if(b.isFunction(m[a]))return m[a].call(this,c);if(b.isPlainObject(c))return b.extend(m[a],c)}return m[a]=c}m.prize=j,f=0,(d=function(){return a[b]?(e&&clearInterval(e),b=a[b],a[c]&&a[c].q&&a[c].q.forEach(function(b){m.apply(a,b)}),a[c]=m,void b(l)):void(!f++&&(e=setInterval(d,50)))})()}(window,"jQuery","admin");